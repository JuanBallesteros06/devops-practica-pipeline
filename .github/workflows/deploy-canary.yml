name: Deploy Canary
on:
  workflow_dispatch:
    inputs:
      canary_weight:
        description: 'Porcentaje de tráfico para canary (5-50)'
        required: false
        default: '5'

env:
  NAMESPACE: production

jobs:
  build:
    runs-on: ubuntu-latest
    outputs:
      image: ${{ steps.build-image.outputs.image }}
    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v2
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push image
        id: build-image
        run: |
          cd backend
          IMAGE_LOWER=$(echo "ghcr.io/${{ github.repository }}/app:${{ github.sha }}" | tr '[:upper:]' '[:lower:]')
          docker build -t $IMAGE_LOWER .
          docker push $IMAGE_LOWER
          echo "image=$IMAGE_LOWER" >> $GITHUB_OUTPUT

  deploy-canary:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup kubectl
        uses: azure/setup-kubectl@v3

      - name: Configure Kubeconfig
        run: |
          echo "${{ secrets.KUBE_CONFIG }}" | base64 -d > kubeconfig
          mkdir -p $HOME/.kube
          mv kubeconfig $HOME/.kube/config
          chmod 600 $HOME/.kube/config

      - name: Deploy canary (v2) with new image
        run: |
          IMAGE_LOWER=${{ needs.build.outputs.image }}
          kubectl set image deployment/crud-backend-v2 \
            crud-backend=$IMAGE_LOWER \
            -n ${{ env.NAMESPACE }}
          
          kubectl rollout status deployment/crud-backend-v2 \
            -n ${{ env.NAMESPACE }} \
            --timeout=3m

      - name: Update VirtualService traffic split
        run: |
          CANARY_WEIGHT=${{ github.event.inputs.canary_weight || '5' }}
          V1_WEIGHT=$((100 - CANARY_WEIGHT))
          
          kubectl apply -n ${{ env.NAMESPACE }} -f - <<EOF
          apiVersion: networking.istio.io/v1alpha3
          kind: VirtualService
          metadata:
            name: crud-backend-virtualservice
          spec:
            hosts:
              - crud.example
            http:
              - name: primary
                route:
                  - destination:
                      host: crud-backend-service
                      subset: v1
                    weight: ${V1_WEIGHT}
                  - destination:
                      host: crud-backend-service
                      subset: v2
                    weight: ${CANARY_WEIGHT}
          EOF

      - name: Wait for canary stabilization
        run: |
          echo "Esperando 2 minutos para que el canary se estabilice..."
          sleep 120

      - name: Run canary analysis
        id: analysis
        run: |
          chmod +x ./scripts/canary-analysis.sh
          ./scripts/canary-analysis.sh

      - name: Promote canary to production
        if: success()
        env:
          IMAGE: ${{ needs.build.outputs.image }}
        run: |
          echo "✅ Canary analysis passed. Promoting to production..."
          chmod +x ./scripts/promote-canary.sh
          ./scripts/promote-canary.sh

      - name: Rollback canary
        if: failure()
        run: |
          echo "❌ Canary analysis failed. Rolling back..."
          chmod +x ./scripts/rollback-canary.sh
          ./scripts/rollback-canary.sh