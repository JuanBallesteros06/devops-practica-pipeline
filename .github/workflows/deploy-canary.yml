name: Deploy Canary
on:
  workflow_dispatch:
    inputs:
      canary_weight:
        description: 'Porcentaje de trÃ¡fico para canary (5-50)'
        required: false
        default: '5'

env:
  NAMESPACE: production

permissions:
  contents: read
  packages: write

jobs:
  build:
    runs-on: ubuntu-latest
    outputs:
      image: ${{ steps.build-image.outputs.image }}
    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v2
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push image
        id: build-image
        run: |
          cd backend
          IMAGE_LOWER=$(echo "ghcr.io/${{ github.repository }}/app:${{ github.sha }}" | tr '[:upper:]' '[:lower:]')
          docker build -t $IMAGE_LOWER .
          docker push $IMAGE_LOWER
          echo "image=$IMAGE_LOWER" >> $GITHUB_OUTPUT

  deploy-canary:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Create K8s cluster (Kind)
        uses: helm/kind-action@v1
        with:
          cluster_name: canary-cluster

      - name: Pull and load image into Kind
        run: |
          docker pull ${{ needs.build.outputs.image }}
          kind load docker-image ${{ needs.build.outputs.image }} --name canary-cluster

      - name: Create namespace
        run: |
          kubectl create namespace ${{ env.NAMESPACE }} --dry-run=client -o yaml | kubectl apply -f -

      - name: Deploy base infrastructure
        run: |
          kubectl apply -f k8s/deployment-v1.yaml -n ${{ env.NAMESPACE }}
          kubectl apply -f k8s/deployment-v2.yaml -n ${{ env.NAMESPACE }}
          kubectl apply -f k8s/service.yaml -n ${{ env.NAMESPACE }}

      - name: Deploy canary (v2) with new image
        run: |
          IMAGE_LOWER=${{ needs.build.outputs.image }}
          kubectl set image deployment/crud-backend-v2 \
            crud-backend=$IMAGE_LOWER \
            -n ${{ env.NAMESPACE }}
          
          kubectl rollout status deployment/crud-backend-v2 \
            -n ${{ env.NAMESPACE }} \
            --timeout=3m

      - name: Update traffic split (simulated)
        run: |
          CANARY_WEIGHT=${{ github.event.inputs.canary_weight || '5' }}
          V1_WEIGHT=$((100 - CANARY_WEIGHT))
          
          echo "ğŸ“Š ConfiguraciÃ³n de trÃ¡fico:"
          echo "   - v1 (stable): ${V1_WEIGHT}%"
          echo "   - v2 (canary): ${CANARY_WEIGHT}%"
          
          # Nota: Sin Istio, simulamos el split con anotaciones
          kubectl annotate deployment/crud-backend-v1 \
            traffic-weight="${V1_WEIGHT}" \
            -n ${{ env.NAMESPACE }} --overwrite
          
          kubectl annotate deployment/crud-backend-v2 \
            traffic-weight="${CANARY_WEIGHT}" \
            -n ${{ env.NAMESPACE }} --overwrite

      - name: Verify deployments
        run: |
          echo "ğŸ“‹ Estado de los deployments:"
          kubectl get deployments -n ${{ env.NAMESPACE }}
          echo ""
          echo "ğŸ“‹ Estado de los pods:"
          kubectl get pods -n ${{ env.NAMESPACE }}
          echo ""
          echo "ğŸ“‹ Estado de los servicios:"
          kubectl get svc -n ${{ env.NAMESPACE }}

      - name: Run canary analysis (simulated)
        id: analysis
        run: |
          echo "ğŸ” Ejecutando anÃ¡lisis de canary..."
          echo ""
          
          # Verificar que los pods estÃ©n corriendo
          READY_PODS=$(kubectl get pods -n ${{ env.NAMESPACE }} -l app=crud-backend --field-selector=status.phase=Running --no-headers | wc -l)
          
          if [ "$READY_PODS" -ge 1 ]; then
            echo "âœ… AnÃ¡lisis exitoso: $READY_PODS pods corriendo"
            echo "analysis_result=success" >> $GITHUB_OUTPUT
          else
            echo "âŒ AnÃ¡lisis fallido: No hay pods corriendo"
            echo "analysis_result=failure" >> $GITHUB_OUTPUT
            exit 1
          fi

      - name: Promote canary to production
        if: success()
        run: |
          echo "âœ… Canary analysis passed. Promoting to production..."
          IMAGE_LOWER=${{ needs.build.outputs.image }}
          
          # Actualizar v1 con la nueva imagen
          kubectl set image deployment/crud-backend-v1 \
            crud-backend=$IMAGE_LOWER \
            -n ${{ env.NAMESPACE }}
          
          kubectl rollout status deployment/crud-backend-v1 \
            -n ${{ env.NAMESPACE }} \
            --timeout=3m
          
          echo "ğŸ‰ PromociÃ³n completada exitosamente"

      - name: Rollback canary
        if: failure()
        run: |
          echo "âŒ Canary analysis failed. Rolling back..."
          kubectl rollout undo deployment/crud-backend-v2 -n ${{ env.NAMESPACE }}
          echo "ğŸ”™ Rollback completado"